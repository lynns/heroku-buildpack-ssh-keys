#!/usr/local/bin/ruby

require 'tmpdir'
require 'fileutils'

def indent(str)
  str.split("\n").each do |line|
    puts "       #{line}"
  end
end

def arrow(str)
  str.split("\n").each do |line|
    puts "-----> #{line}"
  end
end

arrow "Checking for a valid SSH key"

Dir.mktmpdir "env_ssh" do |dir|
  File.open("#{dir}/env_ssh_key", 'w+', 0600) do |f|
    f.puts ENV['SSH_KEY']
  end

  `ssh-keygen -e -f #{dir}/env_ssh_key < /dev/null > #{dir}/env_ssh_key.pub.rfc 2>/dev/null`
  `ssh-keygen -i -f #{dir}/env_ssh_key.pub.rfc > #{dir}/env_ssh_key.pub 2>/dev/null`
  key = `ssh-keygen -l -f #{dir}/env_ssh_key.pub | awk '{print $2}' | tr -ds ':' '' | egrep -ie "[a-f0-9]{32}" 2>/dev/null`

  # if key is empty, abort the build
  if key.strip == ''
    arrow "SSH_KEY was invalid"
    exit 1
  end

  ENV.delete('SSH_KEY')
  File.open("#{dir}/git_ssh", 'w+', 0700) do |f|
    f.puts "ssh -i #{dir}/env_ssh_key $*"
  end
  ENV['GIT_SSH'] = "#{dir}/git_ssh"

  arrow "Checking GitHub identity"
  indent `$GIT_SSH -T git@github.com 2>&1`

  # Execute the real buildpack
  Dir.mktmpdir "proxy_pack" do |pack_dir|

    FileUtils.rm_rf pack_dir

    pack_url = ENV['PROXY_PACK'] || "https://github.com/martinrehfeld/heroku-buildpack-multi.git"
    url, *extra = pack_url.split '#'
    branch = extra.join

    `git clone #{url} #{pack_dir} >/dev/null 2>&1`
    Dir.chdir pack_dir do

      if branch != ''
        `git checkout #{branch} >/dev/null 2>&1`
      end

      `chmod +x ./bin/detect`
      `chmod +x ./bin/compile`
      `chmod +x ./bin/release`
      framework = `./bin/detect #{ARGV[0]}`

      if $?.to_i == 0
        arrow "Found proxy framework #{framework}"

        git_dir = ENV['GIT_DIR']
        ENV.delete('GIT_DIR')
        system "./bin/compile #{ARGV[0]} #{ARGV[1]}"
        $stdout.flush

        status = $?
        if status.to_i != 0
          puts "Last exit: #{status}"
          `touch #{ARGV[0]}/failed`
          exit status.to_i
        end
        
        ENV['GIT_DIR'] = git_dir
        indent "Using release configuration from proxy framework #{framework}"
      else
        indent "The proxy pack at #{pack_url} didn't think it applied to this app."
      end

    end

  end

end